<html>

<head>
  <meta charset="utf-8" />
  <style type="text/css">
    .KlotskiContainer {
      margin-top: 5px;
    }

    .KlotskiPieceContainer {
      position: absolute;
      user-select: none;
      width: 1.5cm;
      height: 1.5cm;
    }

    .DigitalPiece {
      width: 100%;
      height: 100%;
      border: 1mm solid black;
      border-radius: 1mm;
      box-sizing: border-box;
      line-height: 2;
      text-align: center;
      font-size: 6.5mm;
    }

    .ClassicalPiece {
      border: 1mm solid black;
      border-radius: 1mm;
      box-sizing: border-box;
      padding: 5%;
      line-height: 2;
      text-align: center;
      font-size: 6.5mm;
    }

    table {
      border-collapse: collapse;
      float: inline-start;
      margin: 5px;
    }

    td {
      display: table-cell;
      padding: 5px;
      border: 1px solid black;
      text-align: center;
    }

    kbd {
      color: #666;
      display: inline-block;
      padding: 2px 5px;
      background: #f1f1f1;
      text-transform: capitalize;
      text-align: center;
      border-radius: 4px;
      border: 2px solid #e4e4e4;
      box-shadow: inset 0 0 20px white, 0 5px 0 #b1b1b1, 0 6px 0 1px #7e7e7e, 0 8px 5px #a5a5a5;
      margin: 0px 5px;
    }
  </style>
</head>

<body>

  <div>
    <h3>数字华容道</h3>
    <h4>操作说明</h4>
    <div>
      <input id="DigitalKlotskiN" type="number" value="4" min="2" max="6" step="1" />
      <input type="button" value="开始" onclick="resetDigitalKlotski(document.getElementById('DigitalKlotskiN').value)" />
    </div>
    <div id="DigitalKlotskiContainer" class="KlotskiContainer">
    </div>
  </div>

  <div>
    <h3>经典华容道</h3>
    <h4>操作说明</h4>
    <div>
      <table id="ClassicalSetTable"> </table>
      <input type="button" value="重新布局" onclick="document
      .getElementById('ClassicalSetTable')
      .querySelectorAll('input')
      .forEach((inputElement) => {
        inputElement.value = ''
        inputElement.dispatchEvent(new Event('change'))
      })" />
      <input type="button" value="开始" onclick="resetClassicalKlotski()" />
    </div>
    <div id="ClassicalKlotskiContainer" class="KlotskiContainer">
    </div>
  </div>

  <script type="text/javascript">
    'use strict'
    /**
     * 通知发送人
     * @class
     */
    class Notifier {
      constructor() {
        this.listeners = []
      }
      addListener(listener) {
        this.listeners.push(listener)
      }
      removeListener(listener) {
        const i = this.listeners.indexOf(listener)
        if (i >= 0) {
          for (let j = i; j + 1 < this.listeners.length; j++)
            this.listeners[j] = this.listeners[j + 1]
          this.listeners.pop()
        }
      }
      notify(message) {
        for (const listener of this.listeners) {
          listener(message)
        }
      }
    }
  </script>
  <script type="text/javascript">
    'use strict'
    class Orientation {
      static get up() { return 'U' }
      static get down() { return 'D' }
      static get left() { return 'L' }
      static get right() { return 'R' }
    }
  </script>
  <script type="text/javascript">
    'use strict'
    /**
     * 华容道
     */
    class Klotski {
      /**
       * @param {String[][]} data 描述华容道的二维数组，值相等的元素位于同一块，null 为空白
       */
      constructor(data) {
        class KlotskiPiece {
          constructor(name) {
            this.name = name
            this.points = []
            this.beginMoveNotifier = new Notifier()
            this.endMoveNotifier = new Notifier()
          }
          addPoint(x, y) { this.points.push({ x: x, y: y }) }
          get origin() { return this.points[0] }
          *[Symbol.iterator]() { yield* this.points }
        }
        this.data = data.map((rowData) => rowData.map((name) => name)) // 华容道数据
        this.pieceDictionary = data.reduce((dictionary, rowData, y) => {
          rowData.forEach((name, x) => {
            if (name === null) return
            if (dictionary[name] === undefined)
              dictionary[name] = new KlotskiPiece(name)
            dictionary[name].addPoint(x, y)
          })
          return dictionary
        }, {})// 使用名称检索方块
      }
      /** 
       * 检查此方块是否允许移动
       * @param {String} name 方块名称
       * @param {Orientation} Orientation 移动方向
       * @return {Boolean} 此方块是否允许移动
       */
      canMove(name, orientation) {
        this.movePiece = this.pieceDictionary[name]
        switch (orientation) {
          case Orientation.up:
            this.checkFunc = (x, y) => y - 1 >= 0 && this.data[y - 1][x] === null
            this.moveFunc = (x, y, point) => { [this.data[y][x], this.data[y - 1][x]] = [null, this.data[y][x]]; point.y -= 1 }
            break
          case Orientation.down:
            this.checkFunc = (x, y) => y + 1 < this.data.length && this.data[y + 1][x] === null
            this.moveFunc = (x, y, point) => { [this.data[y][x], this.data[y + 1][x]] = [null, this.data[y][x]]; point.y += 1 }
            break
          case Orientation.left:
            this.checkFunc = (x, y) => x - 1 >= 0 && this.data[y][x - 1] === null
            this.moveFunc = (x, y, point) => { [this.data[y][x], this.data[y][x - 1]] = [null, this.data[y][x]]; point.x -= 1 }
            break
          case Orientation.right:
            this.checkFunc = (x, y) => x + 1 < this.data[y].length && this.data[y][x + 1] === null
            this.moveFunc = (x, y, point) => { [this.data[y][x], this.data[y][x + 1]] = [null, this.data[y][x]]; point.x += 1 }
            break
        }
        for (const point of this.movePiece)
          if (this.checkFunc(point.x, point.y) === false) return false
        return true
      }
      /** 
       * 执行移动（必须先调用 canMove）
       */
      move() {
        this.movePiece.beginMoveNotifier.notify()
        for (const point of this.movePiece)
          this.moveFunc(point.x, point.y, point)
        this.movePiece.endMoveNotifier.notify()
      }
      /**
       * 绘制于某个 div 中
       * @param {HTMLDivElement} div
       */
      drawOn(div, getPieceElement) {
        const animationQueue = {
          list: [],
          totalTime: 200, // 旋转动画播放总时长 ms
          frames: 12, // 动画总帧数
          frameValue: function (a, b, progress) {
            return a + (b - a) * progress
          },
          enQueue: function (animation) {
            this.list.push(animation)
            if (this.list.length === 1)
              this.deQueue()
          },
          deQueue: function () {
            let n = 1
            const currentInterval = setInterval((animation) => {
              const [x, y] = [
                this.frameValue(animation.start.x, animation.end.x, n / this.frames),
                this.frameValue(animation.start.y, animation.end.y, n / this.frames),
              ]
              animation.ui.style.transform = `translate(${100 * x}%, ${100 * y}%)`
              if (n >= this.frames) {
                clearInterval(currentInterval)
                this.list.shift()
                if (this.list.length > 0) this.deQueue()
              }
              n += 1
            }, this.totalTime / this.frames, this.list[0])
          }
        }
        for (const key in this.pieceDictionary) {
          const piece = this.pieceDictionary[key]
          const ui = document.createElement('div')
          ui.appendChild(getPieceElement(piece.name))
          ui.className = 'KlotskiPieceContainer'
          ui.style.transform = `translate(${100 * piece.origin.x}%, ${100 * piece.origin.y}%)`
          div.appendChild(ui)
          let start = null
          let end = null
          piece.beginMoveNotifier.addListener(() => start = { ...piece.origin })
          piece.endMoveNotifier.addListener(() => end = { ...piece.origin })
          piece.endMoveNotifier.addListener(() => animationQueue.enQueue({ ui, start, end }))
        }
      }
    }
  </script>
  <script type="text/javascript">
    'use strict'

    let digitalKlotski = null
    const digitalKlotskiContainer = document.getElementById('DigitalKlotskiContainer')
    const digitalPieceDictionary = {
      item(n) {
        if (this[n] === undefined) {
          const div = document.createElement('div')
          div.className = 'DigitalPiece'
          div.innerHTML = n
          this[n] = div
        }
        return this[n]
      }
    }
    function resetDigitalKlotski(n) {
      const data = Array.from({ length: n }, (v, k) => {
        const base = k * n
        return Array.from({ length: n }, (v, k) => base + k + 1)
      })
      data[n - 1][n - 1] = null
      digitalKlotski = new Klotski(data)
      digitalKlotskiContainer.innerHTML = ''
      digitalKlotski.drawOn(digitalKlotskiContainer, (name) => digitalPieceDictionary.item(name))
      digitalKlotskiContainer.style.height =
        digitalKlotskiContainer.firstElementChild.clientHeight * n
      digitalKlotskiContainer.style.width =
        digitalKlotskiContainer.firstElementChild.clientWidth * n
    }

    let classicalKlotski = null
    const classicalKlotskiContainer = document.getElementById('ClassicalKlotskiContainer')
    const createClassicalPiece = (width, height, name) => {
      const div = document.createElement('div')
      div.className = `ClassicalPiece ClassicalPiece_${name}`
      div.style.width = `${100 * width}%`
      div.style.height = `${100 * height}%`
      div.innerHTML = name
      return div
    }
    const classicalPieceDictionary = {
      '曹操': createClassicalPiece(2, 2, '曹操'),
      '关羽': createClassicalPiece(2, 1, '关羽'),
      '黄忠': createClassicalPiece(1, 2, '黄忠'),
      '马超': createClassicalPiece(1, 2, '马超'),
      '张飞': createClassicalPiece(1, 2, '张飞'),
      '赵云': createClassicalPiece(1, 2, '赵云'),
      '卒1': createClassicalPiece(1, 1, '卒'),
      '卒2': createClassicalPiece(1, 1, '卒'),
      '卒3': createClassicalPiece(1, 1, '卒'),
      '卒4': createClassicalPiece(1, 1, '卒'),
    }
    const classicalData = [
      ['张飞', '曹操', '曹操', '赵云',],
      ['张飞', '曹操', '曹操', '赵云',],
      ['黄忠', '关羽', '关羽', '马超',],
      ['黄忠', '卒2', '卒3', '马超',],
      ['卒1', null, null, '卒4',],
    ]
    {
      const table = document.getElementById('ClassicalSetTable')
      const datalist = document.createElement('datalist')
      datalist.id = `datalist${Date.now()}`
      for (const [optionText, totalCount] of Array
        .from(
          classicalData.reduce(
            (map, row) => row.reduce((map, k) => {
              if (k === null) return map
              if (map.has(k) === false) map.set(k, 0)
              map.set(k, map.get(k) + 1)
              return map
            }, map), new Map())
        ).sort(
          (a, b) => a[1] === b[1] ? (a[0] > b[0] ? 1 : -1) : b[1] - a[1]
        )) {
        const option = document.createElement('option')
        let placeCount = totalCount
        option.value = optionText
        option.disabled = true
        option.inc = () => { placeCount += 1; if (placeCount >= totalCount) option.disabled = true }
        option.dec = () => { placeCount -= 1; option.disabled = false }
        datalist.appendChild(option)
      }
      table.appendChild(datalist)
      for (let i = 0; i < 5; i++) {
        const tr = document.createElement('tr')
        for (let j = 0; j < 4; j++) {
          const td = document.createElement('td')
          const input = document.createElement('input')
          input.setAttribute('list', datalist.id)
          input.value = classicalData[i][j] !== null ? classicalData[i][j] : ''
          input.style.width = '4em'
          input.addEventListener('change', (ev) => {
            if (classicalData[i][j] !== null) {
              datalist.querySelector(`[value=${classicalData[i][j]}`).dec()
              classicalData[i][j] = null
            }
            if (input.value.length > 0) {
              const option = datalist.querySelector(`[value=${input.value}`)
              if (option === null) {
                input.value = ''
              } else {
                option.inc()
                classicalData[i][j] = input.value
              }
            }
            input.setAttribute('list', datalist.id)
            // 虽然没有变化，但不再设置一次控件不会出现下拉箭头
            // 兼容性存疑，应考虑改用 select 元素实现这一功能
          })
          td.appendChild(input)
          tr.appendChild(td)
        }
        table.appendChild(tr)
      }
    }
    function resetClassicalKlotski() {
      // 几种布局
      // https://zhidao.baidu.com/question/553058365.html
      classicalKlotski = new Klotski(classicalData)
      classicalKlotskiContainer.innerHTML = ''
      classicalKlotski.drawOn(classicalKlotskiContainer, (name) => classicalPieceDictionary[name])
    }
  </script>
</body>

</html>
